<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨Ø©</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root { --bg:#0e1217; --card:#151a21; --text:#e6e6e6; --muted:#9aa4af; --accent:#3da9f5; }
    * { box-sizing: border-box; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Arabic", "Noto Naskh Arabic", Arial, sans-serif; }
    body { margin:0; background:var(--bg); color:var(--text); }
    .wrap { max-width:560px; margin:0 auto; padding:20px; }
    .card { background:var(--card); border-radius:16px; padding:20px; box-shadow: 0 2px 16px rgba(0,0,0,.25); }
    h1 { font-size:20px; margin:0 0 12px; }
    p { color:var(--muted); margin:0 0 16px; line-height:1.6; }
    label { display:block; margin:12px 0 6px; font-weight:600; }
    input, select, button {
      width:100%; padding:12px 14px; border-radius:12px; border:1px solid #2a313b; background:#0d1117; color:var(--text);
      outline:none;
    }
    input:focus, select:focus { border-color: var(--accent); }
    button { background:var(--accent); border:none; color:#0b0e12; font-weight:700; cursor:pointer; }
    .muted { color:var(--muted); font-size:13px; margin-top:8px; }
    .row { display:grid; gap:12px; grid-template-columns: 1fr 1fr; }
    .hidden { display:none !important; }
    .ok { color:#79f2a0; }
    .warn { color:#ffd166; }
    .err { color:#ff6b6b; }
    .sp { display:inline-block; width:16px; height:16px; border:2px solid #2a313b; border-top-color:var(--accent); border-radius:50%; animation:spin 1s linear infinite; vertical-align:-3px; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Ø§Ù„ØªØ³Ø¬ÙŠÙ„</h1>
      <p id="stateLine">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„ØªÙƒ...</p>

      <form id="form" class="hidden" autocomplete="off">
        <label for="name">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ</label>
        <input id="name" name="name" required placeholder="Ù…Ø«Ø§Ù„: Ø±ÙŠÙ… Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯" inputmode="text" />

        <label for="klass">Ø§Ù„ØµÙ</label>
        <select id="klass" name="klass" required>
          <option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ</option>
          <option value="Ø§Ù„ØµÙ 1">Ø§Ù„ØµÙ 1</option>
          <option value="Ø§Ù„ØµÙ 2">Ø§Ù„ØµÙ 2</option>
          <option value="Ø§Ù„ØµÙ 3">Ø§Ù„ØµÙ 3</option>
          <option value="Ø§Ù„ØµÙ 4">Ø§Ù„ØµÙ 4</option>
          <option value="Ø§Ù„ØµÙ 5">Ø§Ù„ØµÙ 5</option>
          <option value="Ø§Ù„ØµÙ 6">Ø§Ù„ØµÙ 6</option>
        </select>

        <button type="submit" id="submitBtn">ØªØ³Ø¬ÙŠÙ„</button>
        <div class="muted">Ø³ÙŠØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.</div>
      </form>

      <div id="result" class="hidden"></div>

      <div id="closeWrap" class="hidden" style="margin-top:16px;">
        <button id="closeBtn" type="button">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>

  <script>
    const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
    if (tg) {
      tg.ready();
      tg.expand(); // ØªÙˆØ³ÙŠØ¹ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„ÙŠØ£Ø®Ø° ÙƒØ§Ù…Ù„ Ø§Ù„Ø´Ø§Ø´Ø©
      // Ø«ÙŠÙ… ØªÙ„Ø¬Ø±Ø§Ù…
      document.body.style.background = tg.themeParams?.bg_color || getComputedStyle(document.body).backgroundColor;
    }

    const qs = (s) => document.querySelector(s);
    const stateLine = qs('#stateLine');
    const form = qs('#form');
    const result = qs('#result');
    const closeWrap = qs('#closeWrap');
    const closeBtn = qs('#closeBtn');
    const nameEl = qs('#name');
    const klassEl = qs('#klass');
    const submitBtn = qs('#submitBtn');

    // Ù†ÙØ³ Ø§Ù„Ø£ØµÙ„ Ø§Ù„Ø°ÙŠ ÙŠÙ‚Ø¯Ù‘Ù… index.html Ù‡Ùˆ Ù†ÙØ³Ù‡ API origin
    const API_ORIGIN = window.location.origin;
    
    // Ù…ØªØºÙŠØ± Ø¹Ø§Ù… Ù„ØªØ®Ø²ÙŠÙ† Ù…Ø¹Ø±Ù Telegram
    let currentTelegramId = null;

    function getTelegramId() {
      console.log('ğŸ” Starting Telegram ID detection...');
      
      // Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Telegram WebApp
      if (!window.Telegram || !window.Telegram.WebApp) {
        console.log('âŒ Telegram WebApp not loaded - App opened outside Telegram');
        return '';
      }
      
      const tg = window.Telegram.WebApp;
      console.log('âœ… Telegram WebApp object found');
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ¹Ù…Ù„ Ø¯Ø§Ø®Ù„ Telegram
      if (tg.isVersionAtLeast && !tg.isVersionAtLeast('6.0')) {
        console.log('âš ï¸ Telegram WebApp version too old');
      }
      
      // Ø·Ø±ÙŠÙ‚Ø© 1: Ù…Ù† initDataUnsafe (Ø§Ù„Ø£ÙƒØ«Ø± Ø´ÙŠÙˆØ¹Ø§Ù‹)
      if (tg?.initDataUnsafe?.user?.id) {
        console.log('âœ… Got ID from initDataUnsafe:', tg.initDataUnsafe.user.id);
        currentTelegramId = tg.initDataUnsafe.user.id.toString();
        return currentTelegramId;
      }
      
      // Ø·Ø±ÙŠÙ‚Ø© 2: Ù…Ù† initData (URL parameters)
      if (tg?.initData) {
        try {
          console.log('ğŸ” Parsing initData:', tg.initData);
          const urlParams = new URLSearchParams(tg.initData);
          const userStr = urlParams.get('user');
          if (userStr) {
            const user = JSON.parse(decodeURIComponent(userStr));
            if (user?.id) {
              console.log('âœ… Got ID from initData:', user.id);
              currentTelegramId = user.id.toString();
              return currentTelegramId;
            }
          }
        } catch (e) {
          console.log('âŒ Error parsing initData:', e);
        }
      }
      
             // Ø·Ø±ÙŠÙ‚Ø© 3: Ù…Ù† URL parameters Ù…Ø¨Ø§Ø´Ø±Ø©
       try {
         const urlParams = new URLSearchParams(window.location.search);
         const userStr = urlParams.get('user');
         if (userStr) {
           const user = JSON.parse(decodeURIComponent(userStr));
           if (user?.id) {
             console.log('âœ… Got ID from URL parameters:', user.id);
             currentTelegramId = user.id.toString();
             return currentTelegramId;
           }
         }
         
         // Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø©: Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¹Ø±Ù ÙÙŠ URL
         const url = window.location.href;
         const idMatch = url.match(/[?&]user_id=(\d+)/);
         if (idMatch) {
           console.log('âœ… Got ID from URL user_id parameter:', idMatch[1]);
           currentTelegramId = idMatch[1];
           return currentTelegramId;
         }
         
         // Ø·Ø±ÙŠÙ‚Ø© Ø£Ø®Ø±Ù‰: Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¹Ø±Ù ÙÙŠ hash
         const hashMatch = window.location.hash.match(/user_id=(\d+)/);
         if (hashMatch) {
           console.log('âœ… Got ID from URL hash user_id:', hashMatch[1]);
           currentTelegramId = hashMatch[1];
           return currentTelegramId;
         }
       } catch (e) {
         console.log('âŒ Error parsing URL parameters:', e);
       }
      
             // Ø·Ø±ÙŠÙ‚Ø© 4: Ù…Ù† hash ÙÙŠ URL
       try {
         if (window.location.hash) {
           const hashParams = new URLSearchParams(window.location.hash.substring(1));
           const userStr = hashParams.get('user');
           if (userStr) {
             const user = JSON.parse(decodeURIComponent(userStr));
             if (user?.id) {
               console.log('âœ… Got ID from URL hash:', user.id);
               currentTelegramId = user.id.toString();
               return currentTelegramId;
             }
           }
         }
       } catch (e) {
         console.log('âŒ Error parsing URL hash:', e);
       }
       
       // Ø·Ø±ÙŠÙ‚Ø© 5: Ù…Ù† localStorage (Ø¥Ø°Ø§ ØªÙ… Ø­ÙØ¸Ù‡ Ù…Ø³Ø¨Ù‚Ø§Ù‹)
       try {
         const savedId = localStorage.getItem('telegram_user_id');
         if (savedId && savedId.trim()) {
           console.log('âœ… Got ID from localStorage:', savedId);
           currentTelegramId = savedId.trim();
           return currentTelegramId;
         }
       } catch (e) {
         console.log('âŒ Error reading from localStorage:', e);
       }
      
      console.log('âŒ No Telegram ID found - User data not available');
      console.log('Available data:', {
        initDataUnsafe: tg?.initDataUnsafe,
        initData: tg?.initData,
        url: window.location.href,
        hash: window.location.hash
      });
      return '';
    }

    async function apiGetStatus(telegram_id) {
      const url = `${API_ORIGIN}/api/status?telegram_id=${encodeURIComponent(telegram_id)}`;
      const r = await fetch(url, { method: 'GET' });
      if (!r.ok) throw new Error('status_http_' + r.status);
      return await r.json();
    }

    async function apiRegister(payload) {
      const r = await fetch(`${API_ORIGIN}/api/register`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!r.ok) throw new Error('register_http_' + r.status);
      return await r.json();
    }

    function showForm() {
      stateLine.textContent = 'Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ø®ØªØ± Ø§Ù„ØµÙ Ù„Ø¥ØªÙ…Ø§Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„.';
      form.classList.remove('hidden');
      result.classList.add('hidden');
      closeWrap.classList.add('hidden');
      nameEl.focus();
    }

    function showAlreadyRegistered(row) {
      form.classList.add('hidden');
      result.classList.remove('hidden');
      result.className = '';
      result.classList.add('ok');
      result.innerHTML = 'Ø£Ù†Øª Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ù‹Ø§.';
      closeWrap.classList.remove('hidden');
      // Ø¥ØºÙ„Ø§Ù‚ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø§Ø®ØªÙŠØ§Ø±ÙŠ
      if (tg) setTimeout(() => tg.close(), 700);
    }

    function showSuccess() {
      form.classList.add('hidden');
      result.classList.remove('hidden');
      result.className = '';
      result.classList.add('ok');
      result.textContent = 'ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­.';
      closeWrap.classList.remove('hidden');
      if (tg) setTimeout(() => tg.close(), 700);
    }

    function showError(msg) {
      result.classList.remove('hidden');
      result.className = '';
      result.classList.add('err');
      result.textContent = msg || 'Ø­Ø¯Ø« Ø®Ø·Ø£.';
      closeWrap.classList.remove('hidden');
    }

    closeBtn.addEventListener('click', () => {
      if (tg) tg.close();
      else window.close();
    });

    // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¹Ø±Ù ÙŠØ¯ÙˆÙŠØ§Ù‹
    function showManualIdInput() {
      const manualId = prompt('Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù Telegram Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ (ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„ÙŠÙ‡ Ù…Ù† @userinfobot):');
      if (manualId && manualId.trim()) {
        currentTelegramId = manualId.trim();
        // Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø±Ù ÙÙŠ localStorage Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠ
        localStorage.setItem('telegram_user_id', currentTelegramId);
        console.log('âœ… Using manual Telegram ID:', currentTelegramId);
        
        // ØªØ­Ù‚Ù‚ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
        stateLine.innerHTML = 'Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚ <span class="sp"></span>';
        apiGetStatus(currentTelegramId).then(st => {
          if (st.exists) {
            showAlreadyRegistered(st.row);
          } else {
            showForm();
          }
        }).catch(e => {
          showError('ØªØ¹Ø°Ø± Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø§Ù„Ø©.');
        });
      }
    }

    // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„ØªØ´Ø®ÙŠØµ
    function debugTelegramData() {
      const tg = window.Telegram?.WebApp;
      const debugInfo = {
        'User Agent': navigator.userAgent,
        'URL': window.location.href,
        'Hash': window.location.hash,
        'Search': window.location.search,
        'Telegram WebApp Object': !!tg,
        'initDataUnsafe': tg?.initDataUnsafe,
        'initData': tg?.initData,
        'Platform': tg?.platform,
        'Version': tg?.version,
        'Theme': tg?.themeParams,
        'Color Scheme': tg?.colorScheme,
        'Viewport Height': tg?.viewportHeight,
        'Viewport Stable Height': tg?.viewportStableHeight,
        'Header Color': tg?.headerColor,
        'Background Color': tg?.backgroundColor,
        'Is Closing Confirmation Enabled': tg?.isClosingConfirmationEnabled,
        'Back Button': tg?.BackButton,
        'Main Button': tg?.MainButton,
        'Haptic Feedback': tg?.HapticFeedback,
        'Cloud Storage': tg?.CloudStorage,
        'Popup': tg?.Popup,
        'Scan QR Popup': tg?.ScanQrPopup,
        'Settings Button': tg?.SettingsButton,
        'Theme Params': tg?.themeParams,
        'Init Data': tg?.initData,
        'Init Data Unsafe': tg?.initDataUnsafe
      };

      console.log('ğŸ” Telegram WebApp Debug Data:', debugInfo);
      
      // Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø©
      const debugText = JSON.stringify(debugInfo, null, 2);
      const debugWindow = window.open('', '_blank', 'width=800,height=600');
      debugWindow.document.write(`
        <html dir="ltr">
        <head>
          <title>Telegram WebApp Debug Data</title>
          <style>
            body { font-family: monospace; background: #1a1a1a; color: #fff; padding: 20px; }
            pre { background: #2a2a2a; padding: 15px; border-radius: 5px; overflow-x: auto; }
            .copy-btn { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 10px 0; }
          </style>
        </head>
        <body>
          <h2>Telegram WebApp Debug Data</h2>
          <button class="copy-btn" onclick="navigator.clipboard.writeText(document.querySelector('pre').textContent)">Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
          <pre>${debugText}</pre>
        </body>
        </html>
             `);
     }

     // Ø¯Ø§Ù„Ø© Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø¯ÙˆÙ† Ù…Ø¹Ø±Ù Telegram
     function testWithoutId() {
       const testId = '123456789'; // Ù…Ø¹Ø±Ù ØªØ¬Ø±ÙŠØ¨ÙŠ
       currentTelegramId = testId;
       console.log('ğŸ§ª Testing with dummy ID:', testId);
       
       // ØªØ­Ù‚Ù‚ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
       stateLine.innerHTML = 'Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚ <span class="sp"></span>';
       apiGetStatus(testId).then(st => {
         if (st.exists) {
           showAlreadyRegistered(st.row);
         } else {
           showForm();
         }
       }).catch(e => {
         console.log('Test API call failed:', e);
         // Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…ØŒ Ø§Ø¹Ø±Ø¶ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù…Ø¨Ø§Ø´Ø±Ø©
         showForm();
       });
     }

     // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø¥Ø±Ø´Ø§Ø¯Ø§Øª Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¨ÙˆØª
     function showBotSetupGuide() {
       const guideWindow = window.open('', '_blank', 'width=800,height=600');
       guideWindow.document.write(`
         <html dir="rtl">
         <head>
           <title>Ø¥Ø±Ø´Ø§Ø¯Ø§Øª Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¨ÙˆØª</title>
           <style>
             body { font-family: Arial, sans-serif; background: #1a1a1a; color: #fff; padding: 20px; line-height: 1.6; }
             .container { max-width: 700px; margin: 0 auto; }
             h1 { color: #ff6b6b; text-align: center; }
             h2 { color: #3da9f5; margin-top: 30px; }
             .step { background: #2a2a2a; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #3da9f5; }
             .warning { background: #ff6b6b; color: white; padding: 15px; border-radius: 8px; margin: 15px 0; }
             .success { background: #79f2a0; color: #000; padding: 15px; border-radius: 8px; margin: 15px 0; }
             code { background: #333; padding: 5px; border-radius: 3px; font-family: monospace; }
             .copy-btn { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 10px 0; }
           </style>
         </head>
         <body>
           <div class="container">
             <h1>ğŸ”§ Ø¥Ø±Ø´Ø§Ø¯Ø§Øª Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¨ÙˆØª</h1>
             
             <div class="warning">
               <strong>âš ï¸ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:</strong> Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠÙÙØªØ­ ÙƒØ±Ø§Ø¨Ø· Ø¹Ø§Ø¯ÙŠ ÙˆÙ„ÙŠØ³ ÙƒÙ€ Mini App Ø¯Ø§Ø®Ù„ Telegram
             </div>
             
             <h2>Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:</h2>
             
             <div class="step">
               <strong>Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø­Ø°Ù Mini App Ø§Ù„Ø­Ø§Ù„ÙŠ</strong><br>
               1. Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ @BotFather<br>
               2. Ø£Ø±Ø³Ù„ <code>/myapps</code><br>
               3. Ø§Ø®ØªØ± Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ<br>
               4. Ø§Ø®ØªØ± "Delete App"<br>
               5. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°Ù
             </div>
             
             <div class="step">
               <strong>Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø¥Ù†Ø´Ø§Ø¡ Mini App Ø¬Ø¯ÙŠØ¯</strong><br>
               1. Ø£Ø±Ø³Ù„ <code>/newapp</code><br>
               2. Ø§Ø®ØªØ± Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ<br>
               3. Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª"<br>
               4. Ø£Ø¯Ø®Ù„ Ø§Ù„ÙˆØµÙ: "ØªØ·Ø¨ÙŠÙ‚ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª ÙÙŠ Ø§Ù„ØµÙÙˆÙ 1-6"<br>
               5. Ø§Ø±ÙØ¹ ØµÙˆØ±Ø© (512x512 Ø¨ÙƒØ³Ù„)<br>
               6. Ø£Ø¯Ø®Ù„ Web App URL: <code>https://skol-i8yf.onrender.com/</code>
             </div>
             
             <div class="step">
               <strong>Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø¥Ø¹Ø¯Ø§Ø¯ Menu Button</strong><br>
               1. Ø£Ø±Ø³Ù„ <code>/setmenubutton</code><br>
               2. Ø§Ø®ØªØ± Ø§Ù„Ø¨ÙˆØª<br>
               3. Ø£Ø¯Ø®Ù„ Ø§Ù„Ù†Øµ: "ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚"<br>
               4. Ø£Ø¯Ø®Ù„ Web App URL: <code>https://skol-i8yf.onrender.com/</code>
             </div>
             
             <div class="step">
               <strong>Ø§Ù„Ø®Ø·ÙˆØ© 4: Ø¥Ø¹Ø¯Ø§Ø¯ Ø±Ø³Ø§Ù„Ø© Start</strong><br>
               1. Ø£Ø±Ø³Ù„ <code>/setstarttext</code><br>
               2. Ø§Ø®ØªØ± Ø§Ù„Ø¨ÙˆØª<br>
               3. Ø£Ø±Ø³Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø¹ Ø²Ø± Web App:
             </div>
             
             <div style="background: #333; padding: 15px; border-radius: 8px; margin: 15px 0; font-family: monospace; font-size: 12px;">
               Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª ğŸ“š<br><br>
               Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ø£Ø¯Ù†Ø§Ù‡ Ù„ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ğŸ‘‡<br><br>
               [{"text":"ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚","web_app":{"url":"https://skol-i8yf.onrender.com/"}}]
             </div>
             
             <div class="success">
               <strong>âœ… Ø¹Ù†Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­:</strong><br>
               - Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø³ÙŠÙØªØ­ Ø¯Ø§Ø®Ù„ Telegram<br>
               - Ù„Ù† ØªØ¸Ù‡Ø± Ù†Ø§ÙØ°Ø© "Open this link?"<br>
               - Ø³ØªÙƒÙˆÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ØªØ§Ø­Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
             </div>
             
             <button class="copy-btn" onclick="navigator.clipboard.writeText('https://skol-i8yf.onrender.com/')">Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button>
           </div>
         </body>
         </html>
       `);
     }

     // Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Telegram WebApp Ø«Ù… Ø§Ù„Ø¨Ø¯Ø¡
    function initApp() {
      console.log('=== Telegram WebApp Debug Info ===');
      console.log('User Agent:', navigator.userAgent);
      console.log('Telegram WebApp object:', window.Telegram?.WebApp);
      console.log('initDataUnsafe:', window.Telegram?.WebApp?.initDataUnsafe);
      console.log('initData:', window.Telegram?.WebApp?.initData);
      console.log('Platform:', window.Telegram?.WebApp?.platform);
      console.log('Version:', window.Telegram?.WebApp?.version);
      console.log('==================================');
      
      currentTelegramId = getTelegramId();
      console.log('Extracted telegram_id:', currentTelegramId);

      if (!currentTelegramId) {
        const hasWebApp = !!(window.Telegram && window.Telegram.WebApp);
        const hasUser = !!(window.Telegram?.WebApp?.initDataUnsafe?.user);
        const hasInitData = !!(window.Telegram?.WebApp?.initData);
        const currentUrl = window.location.href;
        
        stateLine.innerHTML = `
          <div style="text-align: center; padding: 20px;">
            <h3 style="color: #ff6b6b; margin-bottom: 15px;">âš ï¸ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h3>
            <p>Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Telegram.</p>
            
            <div style="background: #2a313b; padding: 15px; border-radius: 8px; margin: 15px 0; text-align: left;">
              <strong>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ´Ø®ÙŠØµ:</strong><br>
              â€¢ WebApp Ù…ØªØ§Ø­: ${hasWebApp ? 'âœ…' : 'âŒ'}<br>
              â€¢ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${hasUser ? 'âœ…' : 'âŒ'}<br>
              â€¢ initData Ù…ØªØ§Ø­: ${hasInitData ? 'âœ…' : 'âŒ'}<br>
              â€¢ Ø§Ù„Ù…Ù†ØµØ©: ${window.Telegram?.WebApp?.platform || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}<br>
              â€¢ Ø§Ù„Ø¥ØµØ¯Ø§Ø±: ${window.Telegram?.WebApp?.version || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}
            </div>
            
            <div style="background: #1a1f2a; padding: 15px; border-radius: 8px; margin: 15px 0; font-family: monospace; font-size: 12px; text-align: left; overflow-x: auto;">
              <strong>URL Ø§Ù„Ø­Ø§Ù„ÙŠ:</strong><br>
              ${currentUrl}
            </div>
            
                         <div style="background: #ff6b6b; padding: 15px; border-radius: 8px; margin: 15px 0; color: white;">
               <strong>âš ï¸ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:</strong><br>
               Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠÙÙØªØ­ ÙƒØ±Ø§Ø¨Ø· Ø¹Ø§Ø¯ÙŠ ÙˆÙ„ÙŠØ³ ÙƒÙ€ Mini App Ø¯Ø§Ø®Ù„ Telegram!<br>
               Ù‡Ø°Ø§ Ù‡Ùˆ Ø³Ø¨Ø¨ Ø¹Ø¯Ù… ØªÙˆÙØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….
             </div>
             
             <div style="background: #2a313b; padding: 15px; border-radius: 8px; margin: 15px 0;">
               <strong>Ø§Ù„Ø­Ù„ÙˆÙ„ Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©:</strong><br>
               1ï¸âƒ£ <strong>Ø§Ø³ØªØ®Ø¯Ù… "Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¹Ø±Ù ÙŠØ¯ÙˆÙŠØ§Ù‹"</strong> - Ø§Ù„Ø­Ù„ Ø§Ù„Ø³Ø±ÙŠØ¹ Ø§Ù„Ù…Ø¤Ù‚Øª<br>
               2ï¸âƒ£ <strong>Ø§Ø³ØªØ®Ø¯Ù… "Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø¯ÙˆÙ† Ù…Ø¹Ø±Ù"</strong> - Ù„Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©<br>
               3ï¸âƒ£ <strong>Ø£Ø¹Ø¯ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙˆØª ÙÙŠ @BotFather</strong> - Ø§Ù„Ø­Ù„ Ø§Ù„Ø¯Ø§Ø¦Ù…<br>
               4ï¸âƒ£ ØªØ£ÙƒØ¯ Ù…Ù† ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ù† Ø§Ù„Ø¨ÙˆØª ÙÙŠ Telegram<br>
               5ï¸âƒ£ ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Mini App ÙÙŠ @BotFather
             </div>
            
                         <div style="margin-top: 20px;">
               <button onclick="location.reload()" style="background: #ffd166; color: #000; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; margin-right: 10px;">
                 Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„
               </button>
               <button onclick="showManualIdInput()" style="background: #79f2a0; color: #000; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; margin-right: 10px;">
                 Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¹Ø±Ù ÙŠØ¯ÙˆÙŠØ§Ù‹
               </button>
               <button onclick="testWithoutId()" style="background: #9c27b0; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; margin-right: 10px;">
                 Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø¯ÙˆÙ† Ù…Ø¹Ø±Ù
               </button>
               <button onclick="showBotSetupGuide()" style="background: #ff9800; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; margin-right: 10px;">
                 Ø¥Ø±Ø´Ø§Ø¯Ø§Øª Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¨ÙˆØª
               </button>
               <button onclick="debugTelegramData()" style="background: #ff6b6b; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; margin-right: 10px;">
                 Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©
               </button>
               <button onclick="window.close()" style="background: #3da9f5; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                 Ø¥ØºÙ„Ø§Ù‚
               </button>
             </div>
          </div>
        `;
        return;
      }

      // ØªØ­Ù‚Ù‚ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
      stateLine.innerHTML = 'Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚ <span class="sp"></span>';
      apiGetStatus(currentTelegramId).then(st => {
        if (st.exists) {
          showAlreadyRegistered(st.row);
        } else {
          showForm();
        }
      }).catch(e => {
        showError('ØªØ¹Ø°Ø± Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø§Ù„Ø©.');
      });
    }

    // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ ÙƒØ§Ù…Ù„
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(initApp, 100); // Ø§Ù†ØªØ¸Ø§Ø± Ù‚ØµÙŠØ± Ù„ØªØ­Ù…ÙŠÙ„ Telegram script
      });
    } else {
      setTimeout(initApp, 100);
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
    form.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const name = nameEl.value.trim();
      const klass = klassEl.value.trim();
      const telegram_id = currentTelegramId || getTelegramId();

      if (!name || !klass || !telegram_id) {
        showError('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„.');
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = 'ÙŠØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';

      try {
        const res = await apiRegister({
          name, klass, telegram_id,
          initData: tg?.initData || ''
        });
        if (res.status === 'exists') {
          showAlreadyRegistered(res.row);
        } else if (res.status === 'ok') {
          showSuccess();
        } else {
          showError('Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹Ø©.');
        }
      } catch (e) {
        showError('ØªØ¹Ø°Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'ØªØ³Ø¬ÙŠÙ„';
      }
    });
  </script>
</body>
</html>
