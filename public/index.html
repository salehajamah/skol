<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>تسجيل الطالبة</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root { --bg:#0e1217; --card:#151a21; --text:#e6e6e6; --muted:#9aa4af; --accent:#3da9f5; }
    * { box-sizing: border-box; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Arabic", "Noto Naskh Arabic", Arial, sans-serif; }
    body { margin:0; background:var(--bg); color:var(--text); }
    .wrap { max-width:560px; margin:0 auto; padding:20px; }
    .card { background:var(--card); border-radius:16px; padding:20px; box-shadow: 0 2px 16px rgba(0,0,0,.25); }
    h1 { font-size:20px; margin:0 0 12px; }
    p { color:var(--muted); margin:0 0 16px; line-height:1.6; }
    label { display:block; margin:12px 0 6px; font-weight:600; }
    input, select, button {
      width:100%; padding:12px 14px; border-radius:12px; border:1px solid #2a313b; background:#0d1117; color:var(--text);
      outline:none;
    }
    input:focus, select:focus { border-color: var(--accent); }
    button { background:var(--accent); border:none; color:#0b0e12; font-weight:700; cursor:pointer; }
    .muted { color:var(--muted); font-size:13px; margin-top:8px; }
    .row { display:grid; gap:12px; grid-template-columns: 1fr 1fr; }
    .hidden { display:none !important; }
    .ok { color:#79f2a0; }
    .warn { color:#ffd166; }
    .err { color:#ff6b6b; }
    .sp { display:inline-block; width:16px; height:16px; border:2px solid #2a313b; border-top-color:var(--accent); border-radius:50%; animation:spin 1s linear infinite; vertical-align:-3px; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>التسجيل</h1>
      <p id="stateLine">جارِ التحقق من حالتك...</p>

      <form id="form" class="hidden" autocomplete="off">
        <label for="name">الاسم الثلاثي</label>
        <input id="name" name="name" required placeholder="مثال: ريم أحمد محمد" inputmode="text" />

        <label for="klass">الصف</label>
        <select id="klass" name="klass" required>
          <option value="">اختر الصف</option>
          <option value="الصف 1">الصف 1</option>
          <option value="الصف 2">الصف 2</option>
          <option value="الصف 3">الصف 3</option>
          <option value="الصف 4">الصف 4</option>
          <option value="الصف 5">الصف 5</option>
          <option value="الصف 6">الصف 6</option>
        </select>

        <button type="submit" id="submitBtn">تسجيل</button>
        <div class="muted">سيتم إغلاق التطبيق تلقائيًا بعد الإرسال.</div>
      </form>

      <div id="result" class="hidden"></div>

      <div id="closeWrap" class="hidden" style="margin-top:16px;">
        <button id="closeBtn" type="button">إغلاق</button>
      </div>
    </div>
  </div>

  <script>
    const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
    if (tg) {
      tg.ready();
      tg.expand(); // توسيع التطبيق ليأخذ كامل الشاشة
      // ثيم تلجرام
      document.body.style.background = tg.themeParams?.bg_color || getComputedStyle(document.body).backgroundColor;
    }

    const qs = (s) => document.querySelector(s);
    const stateLine = qs('#stateLine');
    const form = qs('#form');
    const result = qs('#result');
    const closeWrap = qs('#closeWrap');
    const closeBtn = qs('#closeBtn');
    const nameEl = qs('#name');
    const klassEl = qs('#klass');
    const submitBtn = qs('#submitBtn');

    // نفس الأصل الذي يقدّم index.html هو نفسه API origin
    const API_ORIGIN = window.location.origin;

    function getTelegramId() {
      // انتظار تحميل Telegram WebApp
      if (!window.Telegram || !window.Telegram.WebApp) {
        console.log('Telegram WebApp not loaded');
        return '';
      }
      
      const tg = window.Telegram.WebApp;
      
      // طريقة محسّنة لقراءة Telegram ID
      if (tg?.initDataUnsafe?.user?.id) {
        console.log('Got ID from initDataUnsafe:', tg.initDataUnsafe.user.id);
        return tg.initDataUnsafe.user.id.toString();
      }
      
      // طريقة بديلة من initData
      if (tg?.initData) {
        try {
          const urlParams = new URLSearchParams(tg.initData);
          const userStr = urlParams.get('user');
          if (userStr) {
            const user = JSON.parse(decodeURIComponent(userStr));
            if (user?.id) {
              console.log('Got ID from initData:', user.id);
              return user.id.toString();
            }
          }
        } catch (e) {
          console.log('Error parsing initData:', e);
        }
      }
      
      console.log('No Telegram ID found');
      return '';
    }

    async function apiGetStatus(telegram_id) {
      const url = `${API_ORIGIN}/api/status?telegram_id=${encodeURIComponent(telegram_id)}`;
      const r = await fetch(url, { method: 'GET' });
      if (!r.ok) throw new Error('status_http_' + r.status);
      return await r.json();
    }

    async function apiRegister(payload) {
      const r = await fetch(`${API_ORIGIN}/api/register`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!r.ok) throw new Error('register_http_' + r.status);
      return await r.json();
    }

    function showForm() {
      stateLine.textContent = 'أدخل الاسم واختر الصف لإتمام التسجيل.';
      form.classList.remove('hidden');
      result.classList.add('hidden');
      closeWrap.classList.add('hidden');
      nameEl.focus();
    }

    function showAlreadyRegistered(row) {
      form.classList.add('hidden');
      result.classList.remove('hidden');
      result.className = '';
      result.classList.add('ok');
      result.innerHTML = 'أنت مسجل مسبقًا.';
      closeWrap.classList.remove('hidden');
      // إغلاق تلقائي اختياري
      if (tg) setTimeout(() => tg.close(), 700);
    }

    function showSuccess() {
      form.classList.add('hidden');
      result.classList.remove('hidden');
      result.className = '';
      result.classList.add('ok');
      result.textContent = 'تم التسجيل بنجاح.';
      closeWrap.classList.remove('hidden');
      if (tg) setTimeout(() => tg.close(), 700);
    }

    function showError(msg) {
      result.classList.remove('hidden');
      result.className = '';
      result.classList.add('err');
      result.textContent = msg || 'حدث خطأ.';
      closeWrap.classList.remove('hidden');
    }

    closeBtn.addEventListener('click', () => {
      if (tg) tg.close();
      else window.close();
    });

    // انتظار تحميل Telegram WebApp ثم البدء
    function initApp() {
      console.log('Telegram WebApp object:', window.Telegram?.WebApp);
      console.log('initDataUnsafe:', window.Telegram?.WebApp?.initDataUnsafe);
      console.log('initData:', window.Telegram?.WebApp?.initData);
      
      const telegram_id = getTelegramId();
      console.log('Extracted telegram_id:', telegram_id);

      if (!telegram_id) {
        const hasWebApp = !!(window.Telegram && window.Telegram.WebApp);
        const hasUser = !!(window.Telegram?.WebApp?.initDataUnsafe?.user);
        stateLine.innerHTML = `تعذر قراءة Telegram ID. تأكد من فتح التطبيق من زر البوت وليس من المتصفح.<br><small>Debug: WebApp=${hasWebApp}, User=${hasUser}</small>`;
        return;
      }

      // تحقق حالة التسجيل
      stateLine.innerHTML = 'جارِ التحقق <span class="sp"></span>';
      apiGetStatus(telegram_id).then(st => {
        if (st.exists) {
          showAlreadyRegistered(st.row);
        } else {
          showForm();
        }
      }).catch(e => {
        showError('تعذر التحقق من الحالة.');
      });
    }

    // بدء التطبيق بعد تحميل كامل
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(initApp, 100); // انتظار قصير لتحميل Telegram script
      });
    } else {
      setTimeout(initApp, 100);
    }

    // إرسال التسجيل
    form.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const name = nameEl.value.trim();
      const klass = klassEl.value.trim();
      const telegram_id = getTelegramId();

      if (!name || !klass || !telegram_id) {
        showError('أكمل الحقول.');
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = 'يتم الإرسال...';

      try {
        const res = await apiRegister({
          name, klass, telegram_id,
          initData: tg?.initData || ''
        });
        if (res.status === 'exists') {
          showAlreadyRegistered(res.row);
        } else if (res.status === 'ok') {
          showSuccess();
        } else {
          showError('استجابة غير متوقعة.');
        }
      } catch (e) {
        showError('تعذر الإرسال.');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'تسجيل';
      }
    });
  </script>
</body>
</html>
