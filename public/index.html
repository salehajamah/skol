<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>تسجيل الطالبة</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root { --bg:#0e1217; --card:#151a21; --text:#e6e6e6; --muted:#9aa4af; --accent:#3da9f5; }
    * { box-sizing: border-box; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Arabic", "Noto Naskh Arabic", Arial, sans-serif; }
    body { margin:0; background:var(--bg); color:var(--text); }
    .wrap { max-width:560px; margin:0 auto; padding:20px; }
    .card { background:var(--card); border-radius:16px; padding:20px; box-shadow: 0 2px 16px rgba(0,0,0,.25); }
    h1 { font-size:20px; margin:0 0 12px; }
    p { color:var(--muted); margin:0 0 16px; line-height:1.6; }
    label { display:block; margin:12px 0 6px; font-weight:600; }
    input, select, button {
      width:100%; padding:12px 14px; border-radius:12px; border:1px solid #2a313b; background:#0d1117; color:var(--text);
      outline:none;
    }
    input:focus, select:focus { border-color: var(--accent); }
    button { background:var(--accent); border:none; color:#0b0e12; font-weight:700; cursor:pointer; }
    .muted { color:var(--muted); font-size:13px; margin-top:8px; }
    .row { display:grid; gap:12px; grid-template-columns: 1fr 1fr; }
    .hidden { display:none !important; }
    .ok { color:#79f2a0; }
    .warn { color:#ffd166; }
    .err { color:#ff6b6b; }
    .sp { display:inline-block; width:16px; height:16px; border:2px solid #2a313b; border-top-color:var(--accent); border-radius:50%; animation:spin 1s linear infinite; vertical-align:-3px; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>التسجيل</h1>
      <p id="stateLine">جارِ التحقق من حالتك...</p>

      <form id="form" class="hidden" autocomplete="off">
        <label for="name">الاسم الثلاثي</label>
        <input id="name" name="name" required placeholder="مثال: ريم أحمد محمد" inputmode="text" />

        <label for="klass">الصف</label>
        <select id="klass" name="klass" required>
          <option value="">اختر الصف</option>
          <option value="الصف 1">الصف 1</option>
          <option value="الصف 2">الصف 2</option>
          <option value="الصف 3">الصف 3</option>
          <option value="الصف 4">الصف 4</option>
          <option value="الصف 5">الصف 5</option>
          <option value="الصف 6">الصف 6</option>
        </select>

        <button type="submit" id="submitBtn">تسجيل</button>
        <div class="muted">سيتم إغلاق التطبيق تلقائيًا بعد الإرسال.</div>
      </form>

      <div id="result" class="hidden"></div>

      <div id="closeWrap" class="hidden" style="margin-top:16px;">
        <button id="closeBtn" type="button">إغلاق</button>
      </div>
    </div>
  </div>

  <script>
    const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
    if (tg) {
      tg.ready();
      tg.expand(); // توسيع التطبيق ليأخذ كامل الشاشة
      // ثيم تلجرام
      document.body.style.background = tg.themeParams?.bg_color || getComputedStyle(document.body).backgroundColor;
    }

    const qs = (s) => document.querySelector(s);
    const stateLine = qs('#stateLine');
    const form = qs('#form');
    const result = qs('#result');
    const closeWrap = qs('#closeWrap');
    const closeBtn = qs('#closeBtn');
    const nameEl = qs('#name');
    const klassEl = qs('#klass');
    const submitBtn = qs('#submitBtn');

    // نفس الأصل الذي يقدّم index.html هو نفسه API origin
    const API_ORIGIN = window.location.origin;
    
    // متغير عام لتخزين معرف Telegram
    let currentTelegramId = null;

    function getTelegramId() {
      console.log('🔍 Starting Telegram ID detection...');
      
      // انتظار تحميل Telegram WebApp
      if (!window.Telegram || !window.Telegram.WebApp) {
        console.log('❌ Telegram WebApp not loaded - App opened outside Telegram');
        return '';
      }
      
      const tg = window.Telegram.WebApp;
      console.log('✅ Telegram WebApp object found');
      
      // التحقق من أن التطبيق يعمل داخل Telegram
      if (tg.isVersionAtLeast && !tg.isVersionAtLeast('6.0')) {
        console.log('⚠️ Telegram WebApp version too old');
      }
      
      // طريقة 1: من initDataUnsafe (الأكثر شيوعاً)
      if (tg?.initDataUnsafe?.user?.id) {
        console.log('✅ Got ID from initDataUnsafe:', tg.initDataUnsafe.user.id);
        currentTelegramId = tg.initDataUnsafe.user.id.toString();
        return currentTelegramId;
      }
      
      // طريقة 2: من initData (URL parameters)
      if (tg?.initData) {
        try {
          console.log('🔍 Parsing initData:', tg.initData);
          const urlParams = new URLSearchParams(tg.initData);
          const userStr = urlParams.get('user');
          if (userStr) {
            const user = JSON.parse(decodeURIComponent(userStr));
            if (user?.id) {
              console.log('✅ Got ID from initData:', user.id);
              currentTelegramId = user.id.toString();
              return currentTelegramId;
            }
          }
        } catch (e) {
          console.log('❌ Error parsing initData:', e);
        }
      }
      
             // طريقة 3: من URL parameters مباشرة
       try {
         const urlParams = new URLSearchParams(window.location.search);
         const userStr = urlParams.get('user');
         if (userStr) {
           const user = JSON.parse(decodeURIComponent(userStr));
           if (user?.id) {
             console.log('✅ Got ID from URL parameters:', user.id);
             currentTelegramId = user.id.toString();
             return currentTelegramId;
           }
         }
         
         // طريقة بديلة: البحث عن معرف في URL
         const url = window.location.href;
         const idMatch = url.match(/[?&]user_id=(\d+)/);
         if (idMatch) {
           console.log('✅ Got ID from URL user_id parameter:', idMatch[1]);
           currentTelegramId = idMatch[1];
           return currentTelegramId;
         }
         
         // طريقة أخرى: البحث عن معرف في hash
         const hashMatch = window.location.hash.match(/user_id=(\d+)/);
         if (hashMatch) {
           console.log('✅ Got ID from URL hash user_id:', hashMatch[1]);
           currentTelegramId = hashMatch[1];
           return currentTelegramId;
         }
       } catch (e) {
         console.log('❌ Error parsing URL parameters:', e);
       }
      
             // طريقة 4: من hash في URL
       try {
         if (window.location.hash) {
           const hashParams = new URLSearchParams(window.location.hash.substring(1));
           const userStr = hashParams.get('user');
           if (userStr) {
             const user = JSON.parse(decodeURIComponent(userStr));
             if (user?.id) {
               console.log('✅ Got ID from URL hash:', user.id);
               currentTelegramId = user.id.toString();
               return currentTelegramId;
             }
           }
         }
       } catch (e) {
         console.log('❌ Error parsing URL hash:', e);
       }
       
       // طريقة 5: من localStorage (إذا تم حفظه مسبقاً)
       try {
         const savedId = localStorage.getItem('telegram_user_id');
         if (savedId && savedId.trim()) {
           console.log('✅ Got ID from localStorage:', savedId);
           currentTelegramId = savedId.trim();
           return currentTelegramId;
         }
       } catch (e) {
         console.log('❌ Error reading from localStorage:', e);
       }
      
      console.log('❌ No Telegram ID found - User data not available');
      console.log('Available data:', {
        initDataUnsafe: tg?.initDataUnsafe,
        initData: tg?.initData,
        url: window.location.href,
        hash: window.location.hash
      });
      return '';
    }

    async function apiGetStatus(telegram_id) {
      const url = `${API_ORIGIN}/api/status?telegram_id=${encodeURIComponent(telegram_id)}`;
      const r = await fetch(url, { method: 'GET' });
      if (!r.ok) throw new Error('status_http_' + r.status);
      return await r.json();
    }

    async function apiRegister(payload) {
      const r = await fetch(`${API_ORIGIN}/api/register`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!r.ok) throw new Error('register_http_' + r.status);
      return await r.json();
    }

    function showForm() {
      stateLine.textContent = 'أدخل الاسم واختر الصف لإتمام التسجيل.';
      form.classList.remove('hidden');
      result.classList.add('hidden');
      closeWrap.classList.add('hidden');
      nameEl.focus();
    }

    function showAlreadyRegistered(row) {
      form.classList.add('hidden');
      result.classList.remove('hidden');
      result.className = '';
      result.classList.add('ok');
      result.innerHTML = 'أنت مسجل مسبقًا.';
      closeWrap.classList.remove('hidden');
      // إغلاق تلقائي اختياري
      if (tg) setTimeout(() => tg.close(), 700);
    }

    function showSuccess() {
      form.classList.add('hidden');
      result.classList.remove('hidden');
      result.className = '';
      result.classList.add('ok');
      result.textContent = 'تم التسجيل بنجاح.';
      closeWrap.classList.remove('hidden');
      if (tg) setTimeout(() => tg.close(), 700);
    }

    function showError(msg) {
      result.classList.remove('hidden');
      result.className = '';
      result.classList.add('err');
      result.textContent = msg || 'حدث خطأ.';
      closeWrap.classList.remove('hidden');
    }

    closeBtn.addEventListener('click', () => {
      if (tg) tg.close();
      else window.close();
    });

    // دالة لإدخال المعرف يدوياً
    function showManualIdInput() {
      const manualId = prompt('أدخل معرف Telegram الخاص بك (يمكنك الحصول عليه من @userinfobot):');
      if (manualId && manualId.trim()) {
        currentTelegramId = manualId.trim();
        // حفظ المعرف في localStorage للاستخدام المستقبلي
        localStorage.setItem('telegram_user_id', currentTelegramId);
        console.log('✅ Using manual Telegram ID:', currentTelegramId);
        
        // تحقق حالة التسجيل
        stateLine.innerHTML = 'جارِ التحقق <span class="sp"></span>';
        apiGetStatus(currentTelegramId).then(st => {
          if (st.exists) {
            showAlreadyRegistered(st.row);
          } else {
            showForm();
          }
        }).catch(e => {
          showError('تعذر التحقق من الحالة.');
        });
      }
    }

    // دالة لعرض البيانات المتاحة للتشخيص
    function debugTelegramData() {
      const tg = window.Telegram?.WebApp;
      const debugInfo = {
        'User Agent': navigator.userAgent,
        'URL': window.location.href,
        'Hash': window.location.hash,
        'Search': window.location.search,
        'Telegram WebApp Object': !!tg,
        'initDataUnsafe': tg?.initDataUnsafe,
        'initData': tg?.initData,
        'Platform': tg?.platform,
        'Version': tg?.version,
        'Theme': tg?.themeParams,
        'Color Scheme': tg?.colorScheme,
        'Viewport Height': tg?.viewportHeight,
        'Viewport Stable Height': tg?.viewportStableHeight,
        'Header Color': tg?.headerColor,
        'Background Color': tg?.backgroundColor,
        'Is Closing Confirmation Enabled': tg?.isClosingConfirmationEnabled,
        'Back Button': tg?.BackButton,
        'Main Button': tg?.MainButton,
        'Haptic Feedback': tg?.HapticFeedback,
        'Cloud Storage': tg?.CloudStorage,
        'Popup': tg?.Popup,
        'Scan QR Popup': tg?.ScanQrPopup,
        'Settings Button': tg?.SettingsButton,
        'Theme Params': tg?.themeParams,
        'Init Data': tg?.initData,
        'Init Data Unsafe': tg?.initDataUnsafe
      };

      console.log('🔍 Telegram WebApp Debug Data:', debugInfo);
      
      // عرض البيانات في نافذة منبثقة
      const debugText = JSON.stringify(debugInfo, null, 2);
      const debugWindow = window.open('', '_blank', 'width=800,height=600');
      debugWindow.document.write(`
        <html dir="ltr">
        <head>
          <title>Telegram WebApp Debug Data</title>
          <style>
            body { font-family: monospace; background: #1a1a1a; color: #fff; padding: 20px; }
            pre { background: #2a2a2a; padding: 15px; border-radius: 5px; overflow-x: auto; }
            .copy-btn { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 10px 0; }
          </style>
        </head>
        <body>
          <h2>Telegram WebApp Debug Data</h2>
          <button class="copy-btn" onclick="navigator.clipboard.writeText(document.querySelector('pre').textContent)">نسخ البيانات</button>
          <pre>${debugText}</pre>
        </body>
        </html>
             `);
     }

     // دالة لاختبار التطبيق بدون معرف Telegram
     function testWithoutId() {
       const testId = '123456789'; // معرف تجريبي
       currentTelegramId = testId;
       console.log('🧪 Testing with dummy ID:', testId);
       
       // تحقق حالة التسجيل
       stateLine.innerHTML = 'جارِ التحقق <span class="sp"></span>';
       apiGetStatus(testId).then(st => {
         if (st.exists) {
           showAlreadyRegistered(st.row);
         } else {
           showForm();
         }
       }).catch(e => {
         console.log('Test API call failed:', e);
         // إذا فشل الاتصال بالخادم، اعرض النموذج مباشرة
         showForm();
       });
     }

     // دالة لعرض إرشادات إصلاح البوت
     function showBotSetupGuide() {
       const guideWindow = window.open('', '_blank', 'width=800,height=600');
       guideWindow.document.write(`
         <html dir="rtl">
         <head>
           <title>إرشادات إصلاح البوت</title>
           <style>
             body { font-family: Arial, sans-serif; background: #1a1a1a; color: #fff; padding: 20px; line-height: 1.6; }
             .container { max-width: 700px; margin: 0 auto; }
             h1 { color: #ff6b6b; text-align: center; }
             h2 { color: #3da9f5; margin-top: 30px; }
             .step { background: #2a2a2a; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #3da9f5; }
             .warning { background: #ff6b6b; color: white; padding: 15px; border-radius: 8px; margin: 15px 0; }
             .success { background: #79f2a0; color: #000; padding: 15px; border-radius: 8px; margin: 15px 0; }
             code { background: #333; padding: 5px; border-radius: 3px; font-family: monospace; }
             .copy-btn { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 10px 0; }
           </style>
         </head>
         <body>
           <div class="container">
             <h1>🔧 إرشادات إصلاح البوت</h1>
             
             <div class="warning">
               <strong>⚠️ المشكلة:</strong> التطبيق يُفتح كرابط عادي وليس كـ Mini App داخل Telegram
             </div>
             
             <h2>الخطوات المطلوبة:</h2>
             
             <div class="step">
               <strong>الخطوة 1: حذف Mini App الحالي</strong><br>
               1. اذهب إلى @BotFather<br>
               2. أرسل <code>/myapps</code><br>
               3. اختر البوت الخاص بك<br>
               4. اختر "Delete App"<br>
               5. تأكد من الحذف
             </div>
             
             <div class="step">
               <strong>الخطوة 2: إنشاء Mini App جديد</strong><br>
               1. أرسل <code>/newapp</code><br>
               2. اختر البوت الخاص بك<br>
               3. أدخل اسم التطبيق: "تسجيل الطالبات"<br>
               4. أدخل الوصف: "تطبيق لتسجيل الطالبات في الصفوف 1-6"<br>
               5. ارفع صورة (512x512 بكسل)<br>
               6. أدخل Web App URL: <code>https://skol-i8yf.onrender.com/</code>
             </div>
             
             <div class="step">
               <strong>الخطوة 3: إعداد Menu Button</strong><br>
               1. أرسل <code>/setmenubutton</code><br>
               2. اختر البوت<br>
               3. أدخل النص: "فتح التطبيق"<br>
               4. أدخل Web App URL: <code>https://skol-i8yf.onrender.com/</code>
             </div>
             
             <div class="step">
               <strong>الخطوة 4: إعداد رسالة Start</strong><br>
               1. أرسل <code>/setstarttext</code><br>
               2. اختر البوت<br>
               3. أرسل الرسالة مع زر Web App:
             </div>
             
             <div style="background: #333; padding: 15px; border-radius: 8px; margin: 15px 0; font-family: monospace; font-size: 12px;">
               مرحباً بك في تطبيق تسجيل الطالبات 📚<br><br>
               انقر على الزر أدناه لفتح التطبيق 👇<br><br>
               [{"text":"فتح التطبيق","web_app":{"url":"https://skol-i8yf.onrender.com/"}}]
             </div>
             
             <div class="success">
               <strong>✅ عند النجاح:</strong><br>
               - التطبيق سيفتح داخل Telegram<br>
               - لن تظهر نافذة "Open this link?"<br>
               - ستكون بيانات المستخدم متاحة تلقائياً
             </div>
             
             <button class="copy-btn" onclick="navigator.clipboard.writeText('https://skol-i8yf.onrender.com/')">نسخ رابط التطبيق</button>
           </div>
         </body>
         </html>
       `);
     }

     // انتظار تحميل Telegram WebApp ثم البدء
    function initApp() {
      console.log('=== Telegram WebApp Debug Info ===');
      console.log('User Agent:', navigator.userAgent);
      console.log('Telegram WebApp object:', window.Telegram?.WebApp);
      console.log('initDataUnsafe:', window.Telegram?.WebApp?.initDataUnsafe);
      console.log('initData:', window.Telegram?.WebApp?.initData);
      console.log('Platform:', window.Telegram?.WebApp?.platform);
      console.log('Version:', window.Telegram?.WebApp?.version);
      console.log('==================================');
      
      currentTelegramId = getTelegramId();
      console.log('Extracted telegram_id:', currentTelegramId);

      if (!currentTelegramId) {
        const hasWebApp = !!(window.Telegram && window.Telegram.WebApp);
        const hasUser = !!(window.Telegram?.WebApp?.initDataUnsafe?.user);
        const hasInitData = !!(window.Telegram?.WebApp?.initData);
        const currentUrl = window.location.href;
        
        stateLine.innerHTML = `
          <div style="text-align: center; padding: 20px;">
            <h3 style="color: #ff6b6b; margin-bottom: 15px;">⚠️ مشكلة في التعرف على المستخدم</h3>
            <p>لم يتم العثور على معرف المستخدم في Telegram.</p>
            
            <div style="background: #2a313b; padding: 15px; border-radius: 8px; margin: 15px 0; text-align: left;">
              <strong>معلومات التشخيص:</strong><br>
              • WebApp متاح: ${hasWebApp ? '✅' : '❌'}<br>
              • بيانات المستخدم: ${hasUser ? '✅' : '❌'}<br>
              • initData متاح: ${hasInitData ? '✅' : '❌'}<br>
              • المنصة: ${window.Telegram?.WebApp?.platform || 'غير معروف'}<br>
              • الإصدار: ${window.Telegram?.WebApp?.version || 'غير معروف'}
            </div>
            
            <div style="background: #1a1f2a; padding: 15px; border-radius: 8px; margin: 15px 0; font-family: monospace; font-size: 12px; text-align: left; overflow-x: auto;">
              <strong>URL الحالي:</strong><br>
              ${currentUrl}
            </div>
            
                         <div style="background: #ff6b6b; padding: 15px; border-radius: 8px; margin: 15px 0; color: white;">
               <strong>⚠️ المشكلة الأساسية:</strong><br>
               التطبيق يُفتح كرابط عادي وليس كـ Mini App داخل Telegram!<br>
               هذا هو سبب عدم توفر بيانات المستخدم.
             </div>
             
             <div style="background: #2a313b; padding: 15px; border-radius: 8px; margin: 15px 0;">
               <strong>الحلول المقترحة:</strong><br>
               1️⃣ <strong>استخدم "إدخال المعرف يدوياً"</strong> - الحل السريع المؤقت<br>
               2️⃣ <strong>استخدم "اختبار بدون معرف"</strong> - للتجربة السريعة<br>
               3️⃣ <strong>أعد إعداد البوت في @BotFather</strong> - الحل الدائم<br>
               4️⃣ تأكد من فتح التطبيق من البوت في Telegram<br>
               5️⃣ تحقق من إعدادات Mini App في @BotFather
             </div>
            
                         <div style="margin-top: 20px;">
               <button onclick="location.reload()" style="background: #ffd166; color: #000; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; margin-right: 10px;">
                 إعادة تحميل
               </button>
               <button onclick="showManualIdInput()" style="background: #79f2a0; color: #000; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; margin-right: 10px;">
                 إدخال المعرف يدوياً
               </button>
               <button onclick="testWithoutId()" style="background: #9c27b0; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; margin-right: 10px;">
                 اختبار بدون معرف
               </button>
               <button onclick="showBotSetupGuide()" style="background: #ff9800; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; margin-right: 10px;">
                 إرشادات إصلاح البوت
               </button>
               <button onclick="debugTelegramData()" style="background: #ff6b6b; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; margin-right: 10px;">
                 عرض البيانات المتاحة
               </button>
               <button onclick="window.close()" style="background: #3da9f5; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                 إغلاق
               </button>
             </div>
          </div>
        `;
        return;
      }

      // تحقق حالة التسجيل
      stateLine.innerHTML = 'جارِ التحقق <span class="sp"></span>';
      apiGetStatus(currentTelegramId).then(st => {
        if (st.exists) {
          showAlreadyRegistered(st.row);
        } else {
          showForm();
        }
      }).catch(e => {
        showError('تعذر التحقق من الحالة.');
      });
    }

    // بدء التطبيق بعد تحميل كامل
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(initApp, 100); // انتظار قصير لتحميل Telegram script
      });
    } else {
      setTimeout(initApp, 100);
    }

    // إرسال التسجيل
    form.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const name = nameEl.value.trim();
      const klass = klassEl.value.trim();
      const telegram_id = currentTelegramId || getTelegramId();

      if (!name || !klass || !telegram_id) {
        showError('أكمل الحقول.');
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = 'يتم الإرسال...';

      try {
        const res = await apiRegister({
          name, klass, telegram_id,
          initData: tg?.initData || ''
        });
        if (res.status === 'exists') {
          showAlreadyRegistered(res.row);
        } else if (res.status === 'ok') {
          showSuccess();
        } else {
          showError('استجابة غير متوقعة.');
        }
      } catch (e) {
        showError('تعذر الإرسال.');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'تسجيل';
      }
    });
  </script>
</body>
</html>
